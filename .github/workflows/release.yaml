name: Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout crush-modules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout crush-plugin-poc
        uses: actions/checkout@v4
        with:
          repository: aleksclark/crush
          ref: feat/plugin-system
          path: crush-plugin-poc

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Update go.mod replacements for CI
        run: |
          for mod in otlp agent-status periodic-prompts; do
            cd $mod
            go mod edit -replace github.com/charmbracelet/crush=../crush-plugin-poc
            go mod edit -replace github.com/aleksclark/crush-modules=../
            cd ..
          done

      - name: Generate CalVer tag
        id: calver
        run: |
          # CalVer format: YYYY.MM.DD.BUILD
          DATE=$(date -u +%Y.%m.%d)
          
          # Count existing tags with today's date to determine build number
          EXISTING=$(git tag -l "${DATE}.*" | wc -l)
          BUILD=$((EXISTING + 1))
          
          TAG="${DATE}.${BUILD}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"
          
          # Create and push the tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --skip=validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
